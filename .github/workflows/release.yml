---
name: OSS Binary Builder

on  :
  workflow_dispatch:
    inputs:
      SOURCE:
        description: 项目源码地址（如 https://github.com/org/repo.git）
        required: true
      LANGUAGE:
        description: 项目语言（可选，自动判断）
        required: false
      VERSION:
        description: 构建版本号（可选，默认最新）
        required: false
      BUILD_DIR:
        description: 构建目录（可选，默认项目根目录）
        required: false
      EXTRA_ARGS:
        description: 扩展参数（可选，默认无）
        required: false

jobs:
  checkout:
    runs-on: ubuntu-24.04
    outputs:
      lang: ${{ steps.detect_lang.outputs.lang }}
    steps:
    - name: Detect language
      id: detect_lang
      run: |
        if [ -n "${{ github.event.inputs.LANGUAGE }}" ]; then
          echo "lang=${{ github.event.inputs.LANGUAGE }}" >> $GITHUB_OUTPUT
        else
          git clone "${{ github.event.inputs.SOURCE }}" repo
          cd repo
          if [ -f go.mod ] || [ -f "${{ github.event.inputs.BUILD_DIR }}/go.mod" ]; then
            echo "lang=golang" >> $GITHUB_OUTPUT
          elif [ -f Cargo.toml ] || [ -f "${{ github.event.inputs.BUILD_DIR }}/Cargo.toml" ]; then
            echo "lang=rust" >> $GITHUB_OUTPUT
          elif [ -f manifest.json ] || [ -f src/manifest.json ] || [ -f "${{ github.event.inputs.BUILD_DIR }}/manifest.json" ]; then
            echo "lang=crx" >> $GITHUB_OUTPUT            
          elif [ -f package.json ] || [ -f "${{ github.event.inputs.BUILD_DIR }}/package.json" ]; then
            echo "lang=node" >> $GITHUB_OUTPUT
          elif [ -f pyproject.toml ] || [ -f "${{ github.event.inputs.BUILD_DIR }}/pyproject.toml" ]; then
            echo "lang=python" >> $GITHUB_OUTPUT
          else
            echo "lang=unknown" >> $GITHUB_OUTPUT
          fi
        fi
    - name: Print language
      run: |
        echo "Language: ${{ steps.detect_lang.outputs.lang }}"

  build-go:
    needs: checkout
    if: ${{ needs.checkout.outputs.lang == 'golang' }}
    uses: ./.github/workflows/build-go.yml
    with:
      SOURCE: ${{ github.event.inputs.SOURCE }}
      VERSION: ${{ github.event.inputs.VERSION }}
      BUILD_DIR: ${{ github.event.inputs.BUILD_DIR }}
      EXTRA_ARGS: ${{ github.event.inputs.EXTRA_ARGS }}

  build-rs:
    needs: checkout
    if: ${{ needs.checkout.outputs.lang == 'rust' }}
    uses: ./.github/workflows/build-rust.yml
    with:
      SOURCE: ${{ github.event.inputs.SOURCE }}
      VERSION: ${{ github.event.inputs.VERSION }}
      BUILD_DIR: ${{ github.event.inputs.BUILD_DIR }}
      EXTRA_ARGS: ${{ github.event.inputs.EXTRA_ARGS }}

  build-crx:
    needs: checkout
    if: ${{ needs.checkout.outputs.lang == 'crx' }}
    uses: ./.github/workflows/build-crx.yml
    with:
      SOURCE: ${{ github.event.inputs.SOURCE }}
      VERSION: ${{ github.event.inputs.VERSION }}
      BUILD_DIR: ${{ github.event.inputs.BUILD_DIR }}
      EXTRA_ARGS: ${{ github.event.inputs.EXTRA_ARGS }}
